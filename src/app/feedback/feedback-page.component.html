<div class="feedback-shell">
  <header class="feedback-header">
    <div>
      <h1>Share your experience</h1>
      <p>Select a service and, if you like, the exact suit/style. Rate and add details to help others choose.</p>
    </div>
  </header>

  <section id="feedback-form" class="feedback-card">
    <form (ngSubmit)="sendViaFormspree()" #feedbackForm="ngForm">
      <div class="row">
        <div class="col form-col">
          <label>Service (required)
            <div class="select-wrapper">
              <app-custom-select [options]="services" [(value)]="model.serviceId"></app-custom-select>
            </div>
          </label>

          <label>Suit / Style (optional)
            <div class="select-wrapper">
              <app-custom-select [options]="suitOptions" [(value)]="model.suitId"></app-custom-select>
            </div>
          </label>

          <label class="rating-row">Rating (1–5) <span class="required">*</span>
            <div class="rating-button-group" role="radiogroup" aria-label="Rating">
              <label *ngFor="let r of [1,2,3,4,5]" class="rating-btn-label">
                <input type="radio" name="rating" [value]="r" [(ngModel)]="model.rating" required [attr.aria-label]="r + ' out of 5'" />
                <span class="rating-btn">{{ r }}</span>
              </label>
            </div>
            <small class="error" *ngIf="!model.rating">
              Please select a rating
            </small>
          </label>

          <label>Comments (optional)
            <textarea name="comment" #commentModel="ngModel" [(ngModel)]="model.comment" rows="4" placeholder="Tip: Mention fabric, fit, or turnaround time." minlength="3"></textarea>
            <small class="error" *ngIf="commentModel.invalid && (commentModel.dirty || commentModel.touched)">
              <span *ngIf="commentModel.errors?.['minlength']">Comments must be at least 3 characters</span>
            </small>
          </label>

          <label>Customer name (optional)
            <input type="text" name="name" #nameModel="ngModel" [(ngModel)]="model.name" placeholder="Your name" minlength="2" />
            <small class="error" *ngIf="nameModel.invalid && (nameModel.dirty || nameModel.touched)">
              <span *ngIf="nameModel.errors?.['minlength']">Name must be at least 2 characters</span>
            </small>
          </label>

          <label>Email for follow-up (optional)
            <input type="email" name="email" #emailModel="ngModel" [(ngModel)]="model.email" email />
            <small class="error" *ngIf="emailModel.invalid && (emailModel.dirty || emailModel.touched)">
              <span *ngIf="emailModel.errors?.['email']">Please enter a valid email address</span>
            </small>
          </label>

          <div class="form-actions">
            <label class="consent"><input type="checkbox" name="consent" #consentModel="ngModel" [(ngModel)]="model.consent" required/> <span class="consent-text">I agree my feedback may be displayed on the site</span></label>
            <small class="error" *ngIf="consentModel.invalid && (consentModel.dirty || consentModel.touched)">
              <span *ngIf="consentModel.errors?.['required']">You must agree to share your feedback</span>
            </small>

            <div class="actions">
              <button type="button" class="btn-action secondary" (click)="reset()">
                <i class="fa fa-rotate-left icon" aria-hidden="true"></i>
                <span>Reset</span>
              </button>

              <button type="button" class="btn-action" (click)="sendViaWhatsApp()" [disabled]="!model.serviceId || !model.rating">
                <i class="fa-brands fa-whatsapp icon" aria-hidden="true"></i>
                <span>Send via WhatsApp</span>
              </button>

              <button type="submit" class="btn-action" [disabled]="submitting() || !feedbackForm.valid || !model.consent">
                <i class="fa-solid fa-envelope icon" aria-hidden="true"></i>
                <span>Send via Email</span>
              </button>
            </div>
          </div>
        </div>

        <aside class="col preview-col">
          <h3>Preview</h3>
          <div class="preview-box">
            <pre>{{ formatPreview() }}</pre>
          </div>
          <div *ngIf="successMessage()" class="success">{{ successMessage() }}</div>
        </aside>
      </div>
    </form>

    <hr />

    <h3>Recent feedback</h3>
    <ul class="recent-list">
      <li *ngFor="let fb of recent()"> 
        <div class="meta">{{fb.rating}} ★ — <strong>{{fb.serviceTitle}}</strong> <span *ngIf="fb.suitTitle">/ {{fb.suitTitle}}</span></div>
        <p class="comment">{{fb.comment}}</p>
      </li>
    </ul>
  </section>

  <!-- Success modal (shown after email submission) -->
  <div class="feedback-success-overlay" *ngIf="showSuccessModal()" (click)="closeSuccessModal()">
    <div class="feedback-success-modal" role="dialog" aria-modal="true" (click)="$event.stopPropagation()">
      <button class="modal-close" (click)="closeSuccessModal()" aria-label="Close"><i class="fas fa-times"></i></button>
      <div class="feedback-success-content">
        <h3>Thank you!</h3>
        <p>Your feedback has been sent successfully. We appreciate your time and will use it to improve our services.</p>
        <div class="feedback-success-actions">
          <button class="btn primary" (click)="closeSuccessModal()">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>
