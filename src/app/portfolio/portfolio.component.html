<div class="portfolio-container">
  <!-- Header Section (badge + title + filters) -->
  <header class="portfolio-header">
    <div class="header-left">
      <div class="title-wrap">
        <h1>Explore our work</h1>
        <p class="subtitle">A curated, visual catalog of styles we tailor — click any card to view details without leaving the page.</p>
      </div>
    </div>

    <div class="header-right">
      <div class="filter-bar" role="toolbar" aria-label="Portfolio filters">
        <div class="filter-scroll">
          <!-- Visible filters (first few) - on mobile this is the only visible list -->
          <ng-container *ngFor="let filter of visibleFilters()">
            <button
              [attr.aria-pressed]="selectedFilter() === filter.id"
              [class.active]="selectedFilter() === filter.id"
              (click)="setFilter(filter.id)"
              class="filter-btn mobile-only"
              [attr.title]="filter.label"
            >
              <span class="filter-icon" *ngIf="filter.id === 'all'" aria-hidden="true"><i class="fas fa-filter"></i></span>
              <span class="filter-label">{{ filter.label }}</span>
            </button>
          </ng-container>

          <!-- More button on mobile to open modal with remaining filters -->
          <button class="filter-btn more-btn" (click)="openFiltersModal()" aria-haspopup="dialog" [attr.aria-expanded]="isFiltersModalOpen()">
            <span class="filter-icon" aria-hidden="true"><i class="fas fa-ellipsis-h"></i></span>
            <span class="filter-label">More</span>
          </button>

          <!-- Desktop: full list (kept for larger screens) -->
          <ng-container *ngFor="let filter of filters">
            <button
              [attr.aria-pressed]="selectedFilter() === filter.id"
              [class.active]="selectedFilter() === filter.id"
              (click)="setFilter(filter.id)"
              class="filter-btn desktop-only"
              [attr.title]="filter.label"
            >
              <span class="filter-icon" *ngIf="filter.id === 'all'" aria-hidden="true"><i class="fas fa-filter"></i></span>
              <span class="filter-label">{{ filter.label }}</span>
            </button>
          </ng-container>
        </div>
      </div>

      <!-- Filters Modal (mobile) -->
      <div class="filters-modal-overlay" *ngIf="isFiltersModalOpen()" (click)="closeFiltersModal()">
        <div class="filters-modal" (click)="$event.stopPropagation()" role="dialog" aria-modal="true" aria-label="More filters">
          <button class="modal-close" (click)="closeFiltersModal()" aria-label="Close filters">
            <i class="fas fa-times"></i>
          </button>

          <h3>More filters</h3>
          <div class="filters-list">
            <button
              *ngFor="let filter of moreFilters()"
              class="filter-btn"
              [class.active]="selectedFilter() === filter.id"
              (click)="setFilter(filter.id); closeFiltersModal();"
            >
              {{ filter.label }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Portfolio Grid -->
  <div class="portfolio-grid">
    <div
      *ngFor="let item of filteredItems"
      class="portfolio-card"
      (click)="openModal(item)"
    >
      <div class="card-image">
        <img [src]="item.thumbnailImage" [alt]="item.title" />
        <div class="card-overlay">
          <i class="fas fa-search-plus"></i>
        </div>
      </div>
      <div class="card-content">
        <h3>{{ item.title }}</h3>
        <p class="card-subtitle">{{ item.subtitle }}</p>
      </div>
    </div>
  </div>

  <!-- No Results Message -->
  <div *ngIf="filteredItems.length === 0" class="no-results">
    <p>No items found in this category.</p>
  </div>
</div>

<!-- Modal Overlay -->
<div
  *ngIf="isModalOpen() && selectedItem()"
  class="modal-overlay"
  (click)="closeModal()"
>
  <div class="modal-content" (click)="$event.stopPropagation()">
    <!-- Close Button -->
    <button class="modal-close" (click)="closeModal()" aria-label="Close modal">
      <i class="fas fa-times"></i>
    </button>

    <div class="modal-body">
      <!-- Left: Image Section -->
      <div class="modal-image-section">
        <img
          [src]="selectedItem()!.images[0]"
          [alt]="selectedItem()!.title"
          class="modal-main-image"
        />
      </div>

      <!-- Right: Details Section -->
      <div class="modal-details-section">
        <div class="modal-header-info">
          <button class="item-details-btn">
            <i class="fas fa-info-circle"></i> Item Details
          </button>
          <h2>{{ selectedItem()!.title }}</h2>
        </div>

        <div class="modal-description-wrap">
          <p class="modal-description">{{ selectedItem()!.description }}</p>

          <!-- Pricing boxed note -->
          <div class="pricing-box">
            <i class="fas fa-tag"></i>
            <div class="pricing-text">Starting from <strong>₹{{ selectedItem()!.startingPrice }}</strong>. Final price depends on fabric, embroidery density, and size customization.</div>
          </div>
        </div>

        <!-- Recommended Fabrics -->
        <div class="modal-section">
          <h3>Recommended Fabrics</h3>
          <div class="fabric-tags">
            <span
              *ngFor="let fabric of selectedItem()!.recommendedFabrics"
              class="fabric-tag"
            >
              {{ fabric }}
            </span>
          </div>
        </div>

        <!-- Compact info grid -->
        <div class="info-grid">
          <div class="info-card" *ngIf="selectedItem()!.fit">
            <div class="info-title">Fit & Silhouette</div>
            <div class="info-body">{{ selectedItem()!.fit }}</div>
          </div>

          <div class="info-card" *ngIf="selectedItem()!.occasions && selectedItem()!.occasions!.length > 0">
            <div class="info-title">Occasions</div>
            <div class="info-body">{{ selectedItem()!.occasions!.join(' • ') }}</div>
          </div>

          <div class="info-card" *ngIf="selectedItem()!.customization && selectedItem()!.customization!.length > 0">
            <div class="info-title">Customization</div>
            <div class="info-body">{{ selectedItem()!.customization!.join(', ') }}</div>
          </div>

          <div class="info-card" *ngIf="selectedItem()!.care">
            <div class="info-title">Care</div>
            <div class="info-body">{{ selectedItem()!.care }}</div>
          </div>
        </div>

        <!-- Action row: WhatsApp + Feedback -->
        <div class="modal-actions">
          <!-- WhatsApp CTA opens the enquiry modal (modal-on-modal) -->
          <button
            class="whatsapp-cta"
            (click)="sendWhatsAppInquiry(selectedItem()!)"
            aria-haspopup="dialog"
          >
            <i class="fab fa-whatsapp"></i>
            <span>Inquire about this style on WhatsApp</span>
          </button>

          <!-- Feedback CTA for the specific style -->
          <button class="feedback-cta" (click)="openFeedbackForItem(selectedItem()!)" aria-label="Leave feedback for this style">
            <i class="fas fa-star"></i>
            <span>Leave feedback for this style</span>
          </button>
        </div>

        <!-- Enquiry Modal (modal-on-modal) - Two Column Layout -->
        <div class="enquiry-overlay" *ngIf="isEnquiryOpen()" (click)="closeEnquiry()">
          <div class="enquiry-modal" role="dialog" aria-modal="true" aria-labelledby="enquiry-title" (click)="$event.stopPropagation()">
            <!-- Close button in top-right corner -->
            <button class="enquiry-close-btn" (click)="closeEnquiry()" aria-label="Close enquiry">
              <i class="fas fa-times"></i>
            </button>

            <!-- Modal Header -->
            <div class="enquiry-header">
              <h3 id="enquiry-title">Enquiry</h3>
              <p class="enquiry-sub">We'll prepare a message you can send via WhatsApp or Email with your selected style. Required fields are marked with <span class="required">*</span></p>
            </div>

            <!-- Two-column grid: Left = Form, Right = Preview -->
            <div class="enquiry-columns">
              <!-- LEFT COLUMN: Input Fields -->
              <div class="enquiry-form-column">
                <div class="enquiry-form">
                  <label class="field">
                    <span class="label">Selected Style</span>
                    <input type="text" [value]="selectedItem()!.title" readonly />
                  </label>

                  <div class="form-row">
                    <label class="field small">
                      <span class="label">Quantity</span>
                      <input type="number" [(ngModel)]="enquiry.quantity" min="1" />
                    </label>

                    <label class="field small">
                      <span class="label">Your Name <span class="required">*</span></span>
                      <input name="name" type="text" #nameModel="ngModel" [(ngModel)]="enquiry.name" placeholder="e.g., Jaspreet K." required />
                      <small class="error" *ngIf="nameModel.invalid && (nameModel.dirty || nameModel.touched)">Please enter your name.</small>
                    </label>
                  </div>

                  <div class="form-row phone-row">
                    <label class="field small phone-select">
                      <span class="label">Country code</span>
                      <input list="country-list" name="countryInput" [(ngModel)]="enquiry.countryCode" (ngModelChange)="setCountryFromInput($event)" />
                      <datalist id="country-list">
                        <option *ngFor="let c of countries" [value]="c.code + ' ' + c.name">{{c.code}} {{c.name}}</option>
                      </datalist>
                    </label>

                    <label class="field small phone-input">
                      <span class="label">Phone <span class="required">*</span></span>
                      <input name="phone" type="tel" #phoneModel="ngModel" [(ngModel)]="enquiry.phone" placeholder="98765 43210" required />
                      <small class="helper">Enter local number without country code</small>
                      <small class="error" *ngIf="(phoneModel.invalid && (phoneModel.dirty || phoneModel.touched))">Please enter a phone number.</small>
                      <small class="error" *ngIf="!(isPhoneFormatValid()) && (phoneModel.dirty || phoneModel.touched)">Phone must be 7–15 digits including country code.</small>
                    </label>
                  </div>

                  <label class="field">
                    <span class="label">Email <span class="required">*</span></span>
                    <input name="email" type="email" #emailModel="ngModel" [(ngModel)]="enquiry.email" placeholder="you@example.com" required />
                    <small class="error" *ngIf="emailModel.invalid && (emailModel.dirty || emailModel.touched)">Enter a valid email address.</small>
                  </label>

                  <label class="field">
                    <span class="label">Location (city / country) <span class="required">*</span></span>
                    <input name="location" type="text" #locationModel="ngModel" [(ngModel)]="enquiry.location" placeholder="e.g., Mukerian, India or Surrey, UK" required />
                    <small class="error" *ngIf="locationModel.invalid && (locationModel.dirty || locationModel.touched)">Please enter your location (city, country).</small>
                  </label>

                  <label class="field">
                    <span class="label">Custom instructions / measurements <span class="required">*</span></span>
                    <textarea name="notes" rows="4" #notesModel="ngModel" [(ngModel)]="enquiry.notes" minlength="3" required placeholder="e.g., Chest: 38 inches, Waist: 32 inches, Length: 42 inches"></textarea>
                    <small class="error" *ngIf="notesModel.invalid && (notesModel.dirty || notesModel.touched)">Please provide measurement details or instructions (3+ chars).</small>
                  </label>

                  <!-- Enhanced Visit Options Section -->
                  <div class="field visit-field">
                    <span class="label">Will you visit or send fabric? <span class="required">*</span></span>
                    <div class="visit-options">
                      <label class="visit-option">
                        <input type="radio" name="visit" [(ngModel)]="enquiry.visitOption" value="self" />
                        <span class="visit-card">
                          <i class="fas fa-user"></i>
                          <span class="visit-text">I will come myself</span>
                        </span>
                      </label>
                      <label class="visit-option">
                        <input type="radio" name="visit" [(ngModel)]="enquiry.visitOption" value="someone" />
                        <span class="visit-card">
                          <i class="fas fa-user-friends"></i>
                          <span class="visit-text">Someone on my behalf</span>
                        </span>
                      </label>
                      <label class="visit-option">
                        <input type="radio" name="visit" [(ngModel)]="enquiry.visitOption" value="send-fabric" />
                        <span class="visit-card">
                          <i class="fas fa-shipping-fast"></i>
                          <span class="visit-text">Send by post/courier</span>
                        </span>
                      </label>
                    </div>
                  </div>

                  <!-- If someone will come on your behalf, ask for their name (and optional phone). No address required because they will visit the studio. -->
                  <div *ngIf="enquiry.visitOption === 'someone'">
                    <label class="field">
                      <span class="label">Representative name <span class="required">*</span></span>
                      <input name="repName" type="text" [(ngModel)]="enquiry.representativeName" #repNameModel="ngModel" placeholder="Name of the person who will come" required />
                    </label>

                    <label class="field">
                      <span class="label">Representative phone (optional)</span>
                      <input name="repPhone" type="tel" [(ngModel)]="enquiry.representativePhone" placeholder="e.g., +91 98765 43210" />
                    </label>

                    <small class="helper">Please provide the name (and phone if available) of the person who will visit the studio on your behalf. We may contact them if we need clarifications.</small>
                  </div>

                  <!-- If user is sending fabric, require a pickup/delivery address so the courier can return the finished suit to you. -->
                  <label class="field" *ngIf="enquiry.visitOption === 'send-fabric'">
                    <span class="label">Pickup / Delivery address <span class="required">*</span></span>
                    <textarea rows="2" [(ngModel)]="enquiry.address" [required]="enquiry.visitOption === 'send-fabric'" placeholder="Recipient name, full address, landmark, city, postcode, country"></textarea>
                    <small class="helper">We need a full address to receive the fabric and return the finished suit via courier. Include recipient name, a nearby landmark, city, postcode and country.</small>
                  </label>

                  <div class="field privacy-note">
                    <label class="privacy-checkbox">
                      <input name="consent" type="checkbox" #consentModel="ngModel" [(ngModel)]="enquiryConsent" />
                      <span>I agree that my contact details will be used to respond to this enquiry. We will not share your information with third parties. <a href="/privacy.html" target="_blank">Privacy policy</a>.</span>
                    </label>
                    <small class="error" *ngIf="!enquiryConsent && (nameModel?.touched || phoneModel?.touched || emailModel?.touched)">You must agree to the privacy note to proceed.</small>
                  </div>

                  <div class="enquiry-actions">
                    <button class="btn email" [disabled]="!isEnquiryValid()" (click)="sendEnquiryViaEmail()" aria-label="Send via Email">
                      <i class="fas fa-envelope"></i>
                      Send via Email
                    </button>
                    <button class="btn primary" [disabled]="!isEnquiryValid()" (click)="sendEnquiryViaWhatsApp()" aria-label="Send via WhatsApp">
                      <i class="fab fa-whatsapp"></i>
                      Send via WhatsApp
                    </button>
                  </div>
                </div>
              </div>

              <!-- RIGHT COLUMN: Message Preview -->
              <div class="enquiry-preview-column">
                <div class="preview-sticky">
                  <h4 class="preview-title">
                    <i class="fas fa-eye"></i>
                    Message Preview
                  </h4>
                  <p class="preview-subtitle">This is what will be sent to WhatsApp</p>
                  
                  <div class="preview-card" aria-live="polite">
                    <div class="preview-item">
                      <span class="preview-label">Style</span>
                      <span class="preview-value">{{selectedItem()!.title}}</span>
                    </div>
                    <div class="preview-item">
                      <span class="preview-label">Quantity</span>
                      <span class="preview-value">{{enquiry.quantity}}</span>
                    </div>
                    <div class="preview-divider"></div>
                    <div class="preview-item">
                      <span class="preview-label">Name</span>
                      <span class="preview-value">{{enquiry.name || '—'}}</span>
                    </div>
                    <div class="preview-item">
                      <span class="preview-label">Phone</span>
                      <span class="preview-value">{{enquiry.countryCode}} {{enquiry.phone || '—'}}</span>
                    </div>
                    <div class="preview-item">
                      <span class="preview-label">Email</span>
                      <span class="preview-value">{{enquiry.email || '—'}}</span>
                    </div>
                    <div class="preview-item">
                      <span class="preview-label">Location</span>
                      <span class="preview-value">{{enquiry.location || '—'}}</span>
                    </div>
                    <div class="preview-divider"></div>
                    <div class="preview-item">
                      <span class="preview-label">Visit / Fabric</span>
                      <span class="preview-value">{{ enquiry.visitOption === 'self' ? 'I will come myself' : (enquiry.visitOption === 'someone' ? 'Someone on my behalf' : 'Send by post/courier') }}</span>
                    </div>
                    <div class="preview-item" *ngIf="enquiry.visitOption === 'send-fabric' && enquiry.address">
                      <span class="preview-label">Address</span>
                      <span class="preview-value">{{enquiry.address}}</span>
                    </div>
                    <div class="preview-item" *ngIf="enquiry.visitOption === 'someone' && enquiry.representativeName">
                      <span class="preview-label">Representative</span>
                      <span class="preview-value">{{enquiry.representativeName}}{{ enquiry.representativePhone ? ' (' + enquiry.representativePhone + ')' : '' }}</span>
                    </div>
                    <div class="preview-divider"></div>
                    <div class="preview-notes-section">
                      <span class="preview-label">Measurements / Notes</span>
                      <div class="preview-notes">{{enquiry.notes || 'No notes provided yet...'}}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

                    <!-- Email success modal (shown after Formspree send) -->
                    <div class="email-success-overlay" *ngIf="showEmailSuccessModal" (click)="showEmailSuccessModal = false">
                      <div class="email-success-modal" role="dialog" aria-modal="true" (click)="$event.stopPropagation()">
                        <button class="modal-close" (click)="showEmailSuccessModal = false" aria-label="Close"><i class="fas fa-times"></i></button>
                        <div class="email-success-content">
                          <h3>Message sent</h3>
                          <p>We've successfully sent your enquiry. Below is the message that was sent:</p>
                          <pre class="email-preview">{{ sentMessagePreview }}</pre>
                          <div class="email-success-actions">
                            <button class="btn primary" (click)="showEmailSuccessModal = false">Close</button>
                      <button class="btn" (click)="onSendAnother()">Send another</button>
                          </div>
                          <div *ngIf="emailError" class="error">Error sending message: {{ emailError }}</div>
                        </div>
                      </div>
                    </div>
</div>
